define(["lodash","tslib","@grafana/data","app/plugins/sdk","app/core/utils/kbn"],(function(t,e,r,n,i){return function(t){var e={};function r(n){if(e[n])return e[n].exports;var i=e[n]={i:n,l:!1,exports:{}};return t[n].call(i.exports,i,i.exports,r),i.l=!0,i.exports}return r.m=t,r.c=e,r.d=function(t,e,n){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)r.d(n,i,function(e){return t[e]}.bind(null,i));return n},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="/",r(r.s=5)}([function(e,r){e.exports=t},function(t,r){t.exports=e},function(t,e){t.exports=r},function(t,e){t.exports=n},function(t,e){t.exports=i},function(t,e,r){"use strict";r.r(e);var n,i,a,u,s,o=function(){function t(){}return t.templateUrl="partials/config.html",t}(),c=r(0),l=r.n(c),p=r(1),f=function(){function t(t,e){this.name=t,this.body=e,this.regexp=this.getRegexp()}return t.prototype.run=function(t){return this.body.apply(this,Object(p.__spreadArray)([],Object(p.__read)(t),!1))},t.prototype.getRegexp=function(){return"^"+this.name+"\\(([\\S ]+)\\)$"},t}(),h=function(){function t(t,e,r){this.interval=void 0,this.unit=void 0,this.count=void 0,this.interval=t,this.unit=e,this.count=r}return t.prototype.asString=function(){return"time("+this.interval+", "+this.unit+", "+this.count+")"},t}();function m(t){return l.a.keys(l.a.pickBy(l.a.values(t),(function(t){return!l.a.isNumber(t)})))}!function(t){t[t.MILLISECONDS=0]="MILLISECONDS",t[t.SECONDS=1]="SECONDS",t[t.MINUTES=2]="MINUTES",t[t.HOURS=3]="HOURS",t[t.DAYS=4]="DAYS",t[t.WEEKS=5]="WEEKS",t[t.MONTHS=6]="MONTHS",t[t.YEARS=7]="YEARS"}(n||(n={})),function(t){t[t.first=0]="first",t[t.last=1]="last",t[t.both=2]="both"}(i||(i={})),function(t){t[t.NONE=0]="NONE",t[t.START_TIME=1]="START_TIME",t[t.SAMPLING=2]="SAMPLING",t[t.PERIOD=3]="PERIOD"}(a||(a={})),function(t){t[t.GT=0]="GT",t[t.GTE=1]="GTE",t[t.EQUAL=2]="EQUAL",t[t.LTE=3]="LTE",t[t.LT=4]="LT"}(u||(u={})),function(t){t[t.keep=0]="keep",t[t.discard=1]="discard"}(s||(s={}));var g=function(){function t(){}return t.extractUnit=function(t){var e=this.extractValue(t);return t.replace(e,"")},t.extractValue=function(t){return parseFloat(t).toString()},t.extractFloatValue=function(t){return parseFloat(t)},t.convertTimeUnit=function(e){return t.SHORT_UNITS[e]||t.LONG_UNITS[e]},t.getShortUnit=function(e){return l.a.invert(t.SHORT_UNITS)[e]},t.getString=function(t){return n[t]},t.ceilingToAvailableUnit=function(t,e){var r,i,a=this.intervalToMillis(t);try{for(var u=Object(p.__values)(e),s=u.next();!s.done;s=u.next()){var o=s.value,c=o[0],l=o[1];if(l*this.timeUnitToMillis(c)>=a)return[n[c],l.toString()]}}catch(t){r={error:t}}finally{try{s&&!s.done&&(i=u.return)&&i.call(u)}finally{if(r)throw r.error}}var f=e[e.length-1];return[n[f[0]],f[1].toString()]},t.intervalToUnitValue=function(t){return[this.getTimeUnit(this.extractUnit(t)),this.extractFloatValue(t)]},t.intervalsToUnitValues=function(t){var e=this;return t?t.replace(" ","").split(",").map((function(t){return e.intervalToUnitValue(t)})).filter((function(t){return void 0!==t[0]&&t[1]>0})).sort((function(t,r){return e.unitValueToMillis(t)-e.unitValueToMillis(r)})):[]},t.unitValueToMillis=function(t){return t[1]*this.timeUnitToMillis(t[0])},t.intervalToMillis=function(t){var e=this.extractFloatValue(t),r=this.getTimeUnit(this.extractUnit(t));return e*this.timeUnitToMillis(r)},t.timeUnitToMillis=function(t){switch(t){case n.MILLISECONDS:return 1;case n.SECONDS:return 1e3;case n.MINUTES:return 6e4;case n.HOURS:return 36e5;case n.DAYS:return 864e5;case n.WEEKS:return 6048e5;case n.MONTHS:return 2592e6;case n.YEARS:return 31536e6}},t.getTimeUnit=function(t){return n[this.convertTimeUnit(t)]},t.TIME_UNIT_STRINGS=l.a.values(m(n)),t.SHORT_UNITS=l.a.zipObject(["ms","s","m","h","d","w","M","y"],t.TIME_UNIT_STRINGS),t.LONG_UNITS=l.a.zipObject(["millisecond","second","minute","hour","day","week","month","year"],t.TIME_UNIT_STRINGS),t}(),d=function(t){this.parameters=[],this.name=t},v=function(t,e,r){void 0===e&&(e=t),this.name=t,this.text=e,this.value=r,this.type="sampling"},y=function(t){function e(e,r,n){void 0===r&&(r=e),void 0===n&&(n=null);var i=t.call(this,e,r,n)||this;return i.type="any",i}return Object(p.__extends)(e,t),e.fromObject=function(t){return new e(t.name,t.text,t.value)},e}(v),b=function(t){function e(){var r=t.call(this,e.NAME)||this;return r.parameters=r.parameters.concat([new y("divisor","by")]),r}return Object(p.__extends)(e,t),e.fromObject=function(t){var r=new e;return r.parameters=[y.fromObject(t.parameters[0])],r},e.NAME="div",e}(d),T=function(){function t(t){this.enabled=!1,this.dependentParameters=t,this.enabled=!0}return t.fromObject=function(e,r){var n=new t(r);return n.enabled=e.enabled,n},t}(),S=function(t){function e(e,r,n,i){void 0===n&&(n=e),void 0===i&&(i=null);var a=t.call(this,e,m(r),n,i)||this;return a.type="enum",a}return Object(p.__extends)(e,t),e.fromObject=function(t){return new e(t.name,t.allowedValues,t.text,t.value)},e}(function(t){function e(e,r,n,i){void 0===n&&(n=e),void 0===i&&(i=null);var a=t.call(this,e,n,i)||this;return a.allowedValues=r,a.type="limited",a}return Object(p.__extends)(e,t),e}(v)),w=function(t){function e(){var e=t.call(this,"sampling",a,"align by","PERIOD")||this;return e.type="alignment",e}return Object(p.__extends)(e,t),e.fromObject=function(t){var r=new e;return r.value=t.value,r},e}(S),E=function(t){function e(r,n){void 0===n&&(n=null);var i=t.call(this,"value",r,n)||this;return i.type=e.TYPE,i}return Object(p.__extends)(e,t),e.fromObject=function(t){return new e(t.text,t.value)},e.TYPE="sampling",e}(y),_=function(t){function e(){var r=t.call(this,"unit",n,"unit","HOURS")||this;return r.type=e.TYPE,r}return Object(p.__extends)(e,t),e.fromObject=function(t){var r=new e;return r.value=t.value,r},e.TYPE="sampling_unit",e}(S),O=function(t){function e(e){var r=t.call(this,e)||this,n=new E("every","1"),i=new _;return r.parameters=r.parameters.concat([new w,n,i]),r.autoValueSwitch=new T([n,i]),r}return Object(p.__extends)(e,t),e.fromObject=function(t){var r=new e(t.name),n=w.fromObject(t.parameters[0]),i=E.fromObject(t.parameters[1]),a=_.fromObject(t.parameters[2]);return r.parameters=[n,i,a],r.autoValueSwitch=T.fromObject(t.autoValueSwitch,[i,a]),r},e}(d),N=function(t){function e(){var r=t.call(this,e.NAME)||this;return r.parameters=r.parameters.concat([new y(e.NAME,"percentile (0,1]")]),r}return Object(p.__extends)(e,t),e.fromObject=function(t){var r=new e,n=O.fromObject(t);return r.autoValueSwitch=n.autoValueSwitch,r.parameters=n.parameters.concat([y.fromObject(t.parameters[3])]),r},e.NAME="percentile",e}(O),A=function(t){function e(){var r=t.call(this,e.NAME)||this;return r.parameters=r.parameters.concat([new S("unit",n,"every")]),r}return Object(p.__extends)(e,t),e.fromObject=function(t){var r=t.parameters.find((function(t){return"unit"===t.name})),n=S.fromObject(r),i=new e;return i.parameters=[n],i},e.NAME="rate",e}(d),M=function(t){function e(){var r=t.call(this,e.NAME)||this;return r.parameters=r.parameters.concat([new S("unit",n,"every")]),r}return Object(p.__extends)(e,t),e.fromObject=function(t){var r=new e;return r.parameters=[S.fromObject(t.parameters[0])],r},e.NAME="sampler",e}(d),j=function(t){function e(){var r=t.call(this,e.NAME)||this;return r.parameters=r.parameters.concat([new y("factor","by")]),r}return Object(p.__extends)(e,t),e.fromObject=function(t){var r=new e;return r.parameters=[y.fromObject(t.parameters[0])],r},e.NAME="scale",e}(d),I=function(t){function e(){var r=t.call(this,e.NAME)||this;return r.parameters=r.parameters.concat([new S("trim",i,"by")]),r}return Object(p.__extends)(e,t),e.fromObject=function(t){var r=new e;return r.parameters=[S.fromObject(t.parameters[0])],r},e.NAME="trim",e}(d),R=r(2),U=function(t){function e(){var r=t.call(this,e.NAME)||this;return r.parameters=r.parameters.concat([new y("target")]),r}return Object(p.__extends)(e,t),e.fromObject=function(t){var r=new e,n=O.fromObject(t);return r.autoValueSwitch=n.autoValueSwitch,r.parameters=n.parameters.concat([y.fromObject(t.parameters[3])]),r},e.NAME="apdex",e}(O),V=function(t){function e(){var r=t.call(this,e.NAME)||this;return r.parameters=r.parameters.concat([new S("filter_op",u,"filter"),new y("threshold","threshold"),new S("filter_indeterminate_inclusion",s,"if uncertain",s[s.keep])]),r}return Object(p.__extends)(e,t),e.fromObject=function(t){var r=new e;return r.parameters=[S.fromObject(t.parameters[0]),y.fromObject(t.parameters[1]),S.fromObject(t.parameters[2])],r},e.NAME="filter",e}(d),x=function(t){function e(){var r=t.call(this,e.NAME)||this;return r.parameters=r.parameters.concat([new y("size")]),r}return Object(p.__extends)(e,t),e.fromObject=function(t){var r=new e;return r.parameters=[y.fromObject(t.parameters[0])],r},e.NAME="sma",e}(d),P=[new O("avg"),new O("dev"),new O("count"),new O("first"),new O("gaps"),new O("last"),new O("least_squares"),new O("max"),new O("min"),new O("merge"),new O("movingWindow"),new N,new U,new x,new O("sum"),new d("diff"),new b,new A,new M,new j,new I,new V,new d("percent_remaining")].sort((function(t,e){return t.name.localeCompare(e.name)})),q=["avg","dev","count","first","gaps","last","least_squares","max","min","gaps","merge","sum","movingWindow"],B=["apdex","avg","count","dev","diff","div","first","last","least_squares","max","min","percent_remaining","percentile","rate","sampler","scale","sma","sum"];function C(t){return q.indexOf(t.name)>=0?O.fromObject(t):t.name===N.NAME?N.fromObject(t):t.name===U.NAME?U.fromObject(t):t.name===x.NAME?x.fromObject(t):t.name===b.NAME?b.fromObject(t):t.name===A.NAME?A.fromObject(t):t.name===M.NAME?M.fromObject(t):t.name===j.NAME?j.fromObject(t):t.name===I.NAME?I.fromObject(t):"diff"===t.name?new d("diff"):t.name===V.NAME?V.fromObject(t):"percent_remaining"===t.name?new d("percent_remaining"):t}var L=function(){function t(){this.tags=[],this.value=[],this.time=[]}return t.fromObject=function(e){var r=new t;return e&&(r.tags=e.tags||[],r.value=e.value||[],r.time=(e.time||[]).map((function(t){return new h(t.interval,t.unit,t.count)}))),r},t.prototype.asString=function(){var t="",e=!1;return(this.tags.length>0||this.value.length>0||this.time.length>0)&&(t+=" GROUP BY "),this.tags.length>0&&(e=!0,t+=this.tags.join(", ")),this.value.length>0&&(e&&(t+=", "),e=!0,t+="value("+this.value.join(",")+")"),this.time.length>0&&(e&&(t+=", "),t+=this.time.map((function(t){return t.asString()})).join(", ")),t},t}(),G=function(){function t(t,e,r,n,i,a,u){this.alias=void 0,this.tags={},this.groupBy=new L,this.aggregators=[],this.overrideScalar=void 0,this.metricName=t,this.alias=e,this.tags=r||{},this.groupBy=n||new L,this.aggregators=i||[],this.timeRange=a,this.overrideScalar=u}return t.fromObject=function(e){if(e)return new t(e.metricName,e.alias,e.tags||{},L.fromObject(e.groupBy),(e.aggregators||[]).map(C),e.timeRange,e.overrideScalar);throw"Object was not well formed"},t.prototype.startTime=function(){if(this.timeRange){var t=R.dateMath.parse(this.timeRange.from);if(t)return 1e3*t.unix()}},t.prototype.endTime=function(){if(this.timeRange){var t=R.dateMath.parse(this.timeRange.to);if(t)return 1e3*t.unix()}},t.prototype.asString=function(){var t=this,e="SELECT ";if(this.aggregators.length>0?(this.aggregators.slice().reverse().forEach((function(t){e+=t.name+"("})),this.aggregators.forEach((function(t,r){0===r&&(e+="*"),t.parameters.filter((function(t){return"any"===t.type||"enum"===t.type})).forEach((function(t,n){0!==r&&0===n||(e+=", "),e+=t.value})),e+=")"}))):e+="*",this.alias&&(e+=" as "+this.alias),e+=" FROM "+this.metricName,Object.keys(this.tags).length>0){var r=Object.keys(this.tags).filter((function(e){return!(void 0===t.tags[e]||0===t.tags[e].length)}));r.length>0&&(e+=" WHERE ",r.forEach((function(r,n){0!==n&&(e+=", ");var i=t.tags[r];i.length>1?e+=r+"=["+i.join(",")+"]":e+=r+"="+i[0]})))}return e+=this.groupBy.asString()},t}(),z=function(){function t(){}return t.prototype.convert=function(t){var e=this,r=new G(t.metric,"default"===t.aliasMode?void 0:t.alias,t.tags);if(r.groupBy.tags=t.groupByTags||[],!l.a.isNil(t.nonTagGroupBys)){var n=l.a.groupBy(t.nonTagGroupBys,(function(t){return t.name}));l.a.has(n,"time")&&(r.groupBy.time=n.time.map((function(t){return e.mapGroupByTime(t)}))),l.a.has(n,"value")&&(r.groupBy.value=n.value.map((function(t){return e.mapGroupByValue(t)})))}return l.a.isNil(t.horizontalAggregators)||(r.aggregators=t.horizontalAggregators.map((function(t){return e.convertLegacyAggregator(t)}))),r.overrideScalar=t.overrideScalar||!1,r},t.prototype.isApplicable=function(t){return l.a.isNil(t.query)&&!l.a.isNil(t.horAggregator)},t.prototype.mapGroupByTime=function(t){var e=g.extractValue(t.range_size),r=g.convertTimeUnit(t.range_size.replace(e,""));return new h(e,r,+t.group_count)},t.prototype.mapGroupByValue=function(t){return t.range_size},t.prototype.convertLegacyRangeAggregator=function(t){var e;return"auto"===t.sampling_rate?((e=new O(t.name)).autoValueSwitch.enabled=!0,e):((e=new O(t.name)).autoValueSwitch.enabled=!1,e.parameters[this.findParameterIndex(e,"value")].value=g.extractValue(t.sampling_rate),e.parameters[this.findParameterIndex(e,"unit")].value=g.convertTimeUnit(g.extractUnit(t.sampling_rate)),e)},t.prototype.convertLegacyPercentileAggregator=function(t){var e;return"auto"===t.percentile.sampling_rate?((e=new N).autoValueSwitch.enabled=!0,e.parameters[this.findParameterIndex(e,"percentile")].value=t.percentile,e):((e=new N).parameters[this.findParameterIndex(e,"unit")].value=g.convertTimeUnit(g.extractUnit(t.sampling_rate)),e.parameters[this.findParameterIndex(e,"percentile")].value=t.percentile,e)},t.prototype.convertLegacyAggregator=function(t){switch(t.name){case"avg":case"dev":case"max":case"min":case"count":case"sum":case"least_squares":case"first":case"gaps":case"last":return this.convertLegacyRangeAggregator(t);case"percentile":return this.convertLegacyPercentileAggregator(t);case"diff":return new d("diff");case"div":var e=new b;return e.parameters[this.findParameterIndex(e,"divisor")].value=t.factor,e;case"rate":var r=new A;return r.parameters[this.findParameterIndex(r,"unit")].value=g.convertTimeUnit(t.unit),r;case"sampler":var n=new M;return n.parameters[this.findParameterIndex(n,"unit")].value=g.convertTimeUnit(t.unit),n;case"scale":var i=new j;return i.parameters[this.findParameterIndex(i,"factor")].value=t.factor,i;case"trim":return new I;default:throw new Error("Unknown aggregator type "+t.name)}},t.prototype.findParameterIndex=function(t,e){return l.a.findIndex(t.parameters,(function(t){return t.name===e}))},t}(),D=function(){function t(t){this.functions=[],this.templatingFunctionResolver=t}return t.prototype.register=function(t){this.functions.push(t)},t.prototype.resolve=function(t){var e=l.a.find(this.functions,(function(e){return new RegExp(e.regexp).test(t)}));return this.templatingFunctionResolver.unpackFunction(e,t)},t}(),F=function(){function t(t){this.$q=t}return t.prototype.resolvedPromise=function(t){var e=this.$q.defer();return e.resolve(t),e.promise},t}(),k=function(){function t(t){this.templatingUtils=t}return t.prototype.unpackFunction=function(e,r){var n=this,i=r.match(e.regexp)[1].split(t.FUNCTION_ARGUMENTS_SEPARATOR).map((function(t){return t.trim()})),a=i.filter((function(t){return!n.isFilterArgument(t)})),u=l.a.difference(i,a).map((function(t){return n.mapToFilter(t)}));return function(){return e.body.apply(e,Object(p.__spreadArray)(Object(p.__spreadArray)([],Object(p.__read)(a),!1),[u.reduce((function(t,e){return l.a.merge(t,e)}),{})],!1))}},t.prototype.mapToFilter=function(e){var r=e.split(t.FILTER_ARGUMENT_SEPARATOR),n={};return n[r[0]]=this.templatingUtils.replace(r[1]),n},t.prototype.isFilterArgument=function(e){return t.FILTER_ARGUMENT_REGEXP.test(e)},t.FUNCTION_ARGUMENTS_SEPARATOR=",",t.FILTER_ARGUMENT_SEPARATOR="=",t.FILTER_ARGUMENT_REGEXP=new RegExp("^\\S+"+t.FILTER_ARGUMENT_SEPARATOR),t}(),$=function(){function t(t,e){this.templateSrv=t,this.scopedVars=e}return t.prototype.replace=function(e){var r=this.templateSrv.replace(e,this.scopedVars,t.customFormatterFn);if(r){var n=r.match(t.MULTI_VALUE_REGEX);if(!l.a.isNil(n)){var i=[r];return n.forEach((function(e){var r=e.replace(t.MULTI_VALUE_BOUNDARIES,"").split(t.MULTI_VALUE_SEPARATOR);i=l.a.flatMap(r,(function(t){return i.map((function(r){return r.replace(e,t)}))}))})),i}}return[r]},t.prototype.replaceAll=function(t){var e=this;return l.a.flatten(t.map((function(t){return e.replace(t)})))},t.MULTI_VALUE_SEPARATOR="_MAGIC_DELIM_",t.customFormatterFn=function(e,r,n){if(Array.isArray(e)){if(e.length>1)return"{"+e.join(t.MULTI_VALUE_SEPARATOR)+"}";if(1===e.length)return e[0];throw Error("You can't format an empty array")}return e},t.MULTI_VALUE_REGEX=/{.*?}/g,t.MULTI_VALUE_BOUNDARIES=/[{}]/g,t}(),Q=function(){function t(t,e,r){this.initialized=!1,this.cacheKey="KAIROSDB_METRIC_NAMES_"+r,this.promiseUtils=e,this.datasource=t}return t.prototype.initialize=function(){return this.cacheInitialized()?(this.initialized=!0,this.promiseUtils.resolvedPromise(this.metricNames)):this.fetch()},t.prototype.get=function(){return this.initialized?this.promiseUtils.resolvedPromise(this.metricNames):void 0!==this.fetchingPromise?this.fetchingPromise:this.initialize()},t.prototype.cacheInitialized=function(){return!l.a.isUndefined(window[this.cacheKey])},t.prototype.fetch=function(){var t=this;return this.fetchingPromise=this.datasource.getMetricNames().then((function(t){return t.data.results})).then((function(e){return t.metricNames=e,window[t.cacheKey]=e,t.initialized=!0,t.metricNames})),this.fetchingPromise},t}(),H=function(t,e,r){this.cache_time=0,this.start_absolute=1e3*t.unix(),this.end_absolute=1e3*e.unix(),this.metrics=r},Y=function(t,e,r,n,i,a){this.limit=0,this.name=t,this.tags=e,this.aggregators=r,this.group_by=n,this.start_absolute=i,this.end_absolute=a},K=function(){function t(t,e){this.templatingUtils=t,this.samplingConverter=e}return t.prototype.build=function(t){var e=this,r=[];l.a.isEmpty(t.tags)||r.push({name:"tag",tags:this.templatingUtils.replaceAll(t.tags)});var n=t.time.map((function(t){return{group_count:t.count,name:"time",range_size:e.buildRangeSize(e.samplingConverter.isApplicable(t.interval)?e.samplingConverter.convert(t.interval,t.unit):t)}})),i=t.value.map((function(t){return{name:"value",range_size:t}}));return l.a.concat(r,n,i)},t.prototype.buildRangeSize=function(t){return{unit:t.unit,value:t.interval}},t}(),W=function(){function t(t,e,r,i){var a;if(this.autoValueDependentParameters=[],this.templatingUtils=t,this.autoValueEnabled=!l.a.isNil(r)&&r.enabled,this.autoValueEnabled&&(this.autoValueDependentParameters=r.dependentParameters.map((function(t){return t.type}))),i&&i.length>0)a=Object(p.__read)(g.ceilingToAvailableUnit(e,i),2),this.autoIntervalUnit=a[0],this.autoIntervalValue=a[1];else{var u=Object(p.__read)(g.intervalToUnitValue(e),2),s=u[0],o=u[1];this.autoIntervalValue=o.toString(),this.autoIntervalUnit=n[s]}}return t.prototype.build=function(t){switch(t.type){case"alignment":return this.buildAlignmentParameter(t);case"sampling":return this.buildSamplingParameter(t,this.autoIntervalValue);case"sampling_unit":return this.buildSamplingParameter(t,this.autoIntervalUnit);default:return this.buildDefault(t)}},t.prototype.buildAlignmentParameter=function(t){switch(t.value){case"NONE":return{};case"START_TIME":return{align_start_time:!0};case"SAMPLING":return{align_sampling:!0};case"PERIOD":return{align_sampling:!0,align_start_time:!0};default:throw new Error("Unknown alignment type")}},t.prototype.buildSamplingParameter=function(t,e){var r={sampling:{}};return r.sampling[t.name]=this.isOverriddenByAutoValue(t)?e:t.value,r},t.prototype.buildDefault=function(t){var e={},r=this.templatingUtils.replace(t.value);if(1!==r.length)throw new Error("Multi-value variables not supported in aggregator parameters; name="+t.name+", value="+t.value+", interpretedValues="+r);return e[t.name]=r[0],e},t.prototype.isOverriddenByAutoValue=function(t){return l.a.includes(this.autoValueDependentParameters,t.type)},t}(),X=r(4),J=r.n(X),Z=function(){function t(){}return t.prototype.convert=function(e,r){if(r===t.MILLISECONDS_STRING)throw new Error("Value must be integer when using milliseconds");var i=g.getShortUnit(r);return{interval:this.convertToMiliseconds(parseFloat(e),i).toString(),unit:g.getString(n.MILLISECONDS)}},t.prototype.isApplicable=function(t){return this.isFloat(t)},t.prototype.isFloat=function(t){return t%1!=0},t.prototype.convertToMiliseconds=function(t,e){return Math.round(J.a.intervals_in_seconds[e]*t*1e3)},t.MILLISECONDS_STRING=g.getString(n.MILLISECONDS),t}(),tt=function(){function t(t,e){this.templatingUtils=t,this.samplingConverter=e}return t.prototype.convertSamplingParameters=function(t){var e=t.parameters,r=this.findParameterIndex(e,E.TYPE),n=this.findParameterIndex(e,_.TYPE);if(r>-1&&n>-1){var i=e[r],a=e[n],u=this.templatingUtils.replace(i.value);if(1!==u.length)throw new Error("Multi-value variables not supported in aggregator parameters; name="+i.name+", value="+i.value+", interpretedValues="+u);if(i.value=u[0],this.samplingConverter.isApplicable(i.value)){var s=this.samplingConverter.convert(i.value,a.value);i.value=s.interval,a.value=s.unit}}return t},t.prototype.findParameterIndex=function(t,e){return l.a.findIndex(t,(function(t){return t.type===e}))},t}(),et=function(){function t(t,e,r,n,i,a){this.withCredentials=t,this.url=e,this.apiPath=r,this.scopedVars=i,this.templatingUtils=new $(n,this.scopedVars);var u=new Z;this.groupBysBuilder=new K(this.templatingUtils,u),this.samplingParameterConverter=new tt(this.templatingUtils,u),this.snapToIntervals=a}return t.prototype.buildHealthStatusQuery=function(){return this.buildRequest({method:"GET",url:"/health/status"})},t.prototype.buildMetricNameQuery=function(){return this.buildRequest({method:"GET",url:"/metricnames"})},t.prototype.buildMetricTagsQuery=function(t,e){return void 0===e&&(e={}),this.buildRequest({data:this.buildTagsRequestBody(t,e),method:"POST",url:"/datapoints/query/tags"})},t.prototype.buildDatapointsQuery=function(t,e){var r=this,n=e.range,i=e.interval,a=t.map((function(t){return r.buildMetricQuery(t.query instanceof G?t.query:G.fromObject(t.query),i)})),u=new H(n.from,n.to,a);return this.buildRequest({data:u,method:"POST",url:"/datapoints/query"})},t.prototype.buildMetricQuery=function(t,e){var r=this;return new Y(t.metricName,this.unpackTags(l.a.pickBy(t.tags,(function(t){return t.length}))),t.aggregators.map((function(t){return r.convertAggregatorToQueryObject(t,e)})),this.groupBysBuilder.build(t.groupBy),t.startTime(),t.endTime())},t.prototype.unpackTags=function(t){var e=this;return l.a.mapValues.bind(this)(t,(function(t){return l.a.flatten(e.templatingUtils.replaceAll(t))}))},t.prototype.convertAggregatorToQueryObject=function(t,e){var r=this.samplingParameterConverter.convertSamplingParameters(l.a.cloneDeep(t));return l.a.extend({name:r.name},this.convertParameters(r,e))},t.prototype.convertParameters=function(t,e){var r=new W(this.templatingUtils,e,t.autoValueSwitch,this.snapToIntervals);return t.parameters.map((function(t){return r.build(t)})).reduce((function(t,e){return l.a.merge(t,e)}),{})},t.prototype.buildRequest=function(t){return t.url=this.buildUrl(t.url),l.a.extend(t,{withCredentials:this.withCredentials})},t.prototype.buildRequestId=function(t,e){return t+"_"+e},t.prototype.buildUrl=function(t){return this.url+this.apiPath+t},t.prototype.buildTagsRequestBody=function(t,e){return void 0===e&&(e={}),{cache_time:0,metrics:[{name:t,tags:e}],start_absolute:0}},t}(),rt=function(){function t(t){this.enforceScalarSetting=t}return t.prototype.areValidTargets=function(t){var e=this;if(l.a.isNil(t)||l.a.isEmpty(t))return{valid:!1,reason:"No configured queries."};var r=t.map((function(t){return e.isValidTarget(t.query)})).filter((function(t){return!t.valid}));return l.a.isEmpty(r)?{valid:!0}:r[0]},t.prototype.isValidTarget=function(t){if(l.a.isNil(t)||l.a.isEmpty(t.metricName))return{valid:!1,reason:"An active query has no selected metric."};if(this.enforceScalarSetting&&!t.overrideScalar){if(null==t.aggregators||0===t.aggregators.length)return{valid:!1,reason:'At least one scalar aggregator required for your query on "'+t.metricName+'"'};var e=t.aggregators.reduce((function(t,e){return t||-1!==B.indexOf(e.name)}),!1);return e?{valid:e}:{valid:!1,reason:'At least one scalar aggregator required for your query on "'+t.metricName+'".'}}return{valid:!0}},t}();function nt(t){return(nt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}var it=function(){function t(t){this.seriesNameBuilder=t}return t.prototype.convertToDatapoints=function(t,e){var r=this,n=l.a.zip(e,t.queries).map((function(t){return{alias:t[0],results:t[1].results}})).map((function(t){return l.a.map(t.results,(function(e){return{datapoints:l.a.flatMap(e.values,(function(t){var e=t[1];if(null!==e&&"object"===nt(e)&&e.bins){var r=e.bins;return l.a.map(Object.keys(r),(function(e){return[parseFloat(e),t[0],r[e]]}))}return[t.reverse()]})),target:r.seriesNameBuilder.build(e.name,t.alias,e.group_by)}}))}));return{data:l.a.flatten(n)}},t}(),at=function(){function t(){}return t.prototype.build=function(t,e,r){void 0===r&&(r=[]);var n=l.a.find(r,(function(t){return"tag"===t.name})),i=this.getTagGroupBys(n),a=this.getValueGroupBys(r),u=this.getTimeGroupBys(r);return e?this.buildAlias(e,n,a,u):this.buildDefault(t,i,a,u)},t.prototype.buildDefault=function(e,r,n,i){return l.a.flatten([e,r,n,i]).filter((function(t){return!l.a.isEmpty(t)})).join(t.SEPARATOR)},t.prototype.buildAlias=function(t,e,r,n){var i=this,a=t;return l.a.isNil(e)||l.a.mapKeys(e.group,(function(t,e){a=a.replace(i.getGroupByExpression("tag",e),t)})),r.map((function(t,e){a=a.replace(i.getGroupByExpression("value",e),t)})),n.map((function(t,e){a=a.replace(i.getGroupByExpression("time",e),t)})),a},t.prototype.getTagGroupBys=function(t){return l.a.isNil(t)?[]:l.a.values(t.group)},t.prototype.getValueGroupBys=function(t){return t.filter((function(t){return"value"===t.name})).map((function(t){return"G"+t.group.group_number}))},t.prototype.getTimeGroupBys=function(e){return e.filter((function(t){return"time"===t.name})).map((function(e){return"G"+e.group.group_number+t.SEPARATOR+e.group_count}))},t.prototype.getGroupByExpression=function(t,e){return"$_"+t+"_group_"+e},t.SEPARATOR="_",t}(),ut=function(){function t(t,e,r,n){this.initialized=!1,this.initializationError=!1,this.type=t.type,this.url=t.url,this.name=t.name,this.withCredentials=t.withCredentials,this.basicAuth=t.basicAuth,this.backendSrv=r,this.templateSrv=n,this.responseHandler=new it(new at),this.promiseUtils=new F(e),this.metricNamesStore=new Q(this,this.promiseUtils,this.url),this.templatingUtils=new $(n,{}),this.templatingFunctionsCtrl=new D(new k(this.templatingUtils)),this.targetValidator=new rt(t.jsonData.enforceScalarSetting),this.legacyTargetConverter=new z,this.snapToIntervals=g.intervalsToUnitValues(t.jsonData.snapToIntervals),this.enforceScalarSetting=t.jsonData.enforceScalarSetting,this.registerTemplatingFunctions()}return t.prototype.initialize=function(){var t=this;return this.metricNamesStore.initialize().then((function(){return t.initialized=!0}),(function(){return t.initializationError=!0})).then((function(){return t.initialized}))},t.prototype.testDatasource=function(){return this.executeRequest(this.getRequestBuilder().buildHealthStatusQuery()).then((function(t){return t.status}))},t.prototype.query=function(t){var e=this,r=l.a.cloneDeep(t.targets.filter((function(t){return!t.hide}))),n=l.a.map(r,(function(t){return e.legacyTargetConverter.isApplicable(t)?{query:e.legacyTargetConverter.convert(t)}:t.query instanceof G?t:{query:G.fromObject(t.query)}})),i=this.targetValidator.areValidTargets(n);if(!i.valid)return Promise.reject({message:i.reason});var a=new $(this.templateSrv,t.scopedVars),u=a.replaceAll(n.map((function(t){return t.query.alias}))),s=l.a.flatten(n.map((function(t){return a.replace(t.query.metricName).map((function(e){var r=l.a.cloneDeep(t);return r.query.metricName=e,r}))}))),o=this.getRequestBuilder(t.scopedVars),c=null;try{c=o.buildDatapointsQuery(s,t)}catch(t){return Promise.reject({message:t.message})}return this.executeRequest(c).then((function(t){return e.responseHandler.convertToDatapoints(t.data,u)}))},t.prototype.getMetricTags=function(t,e){void 0===e&&(e={});var r=this.templatingUtils.replace(t)[0];return this.executeRequest(this.getRequestBuilder().buildMetricTagsQuery(r,e)).then(this.handleMetricTagsResponse)},t.prototype.metricFindQuery=function(t){var e=this;return this.templatingFunctionsCtrl.resolve(t)().then((function(t){return t.map((function(t){return e.mapToTemplatingValue(t)}))}))},t.prototype.getMetricNames=function(){return this.executeRequest(this.getRequestBuilder().buildMetricNameQuery())},t.prototype.getRequestBuilder=function(t){return void 0===t&&(t={}),new et(this.withCredentials,this.url,"/api/v1",this.templateSrv,t,this.snapToIntervals)},t.prototype.executeRequest=function(t){return this.backendSrv.datasourceRequest(t)},t.prototype.handleMetricTagsResponse=function(t){return t.data.queries[0].results[0].tags},t.prototype.registerTemplatingFunctions=function(){var t=this;[new f("metrics",(function(e){return t.getMetricNamesContaining(e)})),new f("tag_names",this.getMetricTagNames.bind(this)),new f("tag_values",this.getMetricTagValues.bind(this))].forEach((function(e){return t.templatingFunctionsCtrl.register(e)}))},t.prototype.getMetricNamesContaining=function(t){return this.metricNamesStore.get().then((function(e){return l.a.filter(e,(function(e){return l.a.includes(e,t)}))}))},t.prototype.getMetricTagNames=function(t){return this.getMetricTags(t).then((function(t){return l.a.keys(t)}))},t.prototype.getMetricTagValues=function(t,e,r){return this.getMetricTags(t,r).then((function(t){return l.a.values(t[e])}))},t.prototype.mapToTemplatingValue=function(t){return{text:t,value:t}},t}(),st=r(3),ot=function(){function t(){this.tags={},this.size=0,this.initialized=!1,this.combinations=0,this.multiValuedTags=[]}return t.prototype.updateTags=function(t){this.tags=t,this.updateInfo(),this.initialized=!0},t.prototype.updateInfo=function(){var t=l.a.pickBy(this.tags,(function(t){return t.length}));this.combinations=l.a.reduce(l.a.map(t,(function(t){return t.length})),(function(t,e){return t*e}))||0,this.multiValuedTags=l.a.keys(l.a.pickBy(t,(function(t){return t.length>1}))),this.size=l.a.keys(this.tags).length},t}();!function(){function t(){}t.prototype.add=function(t){this.entries.push(t)},t.prototype.remove=function(t){this.entries=l.a.without(this.entries,t)},t.prototype.up=function(t){var e=this.entries.indexOf(t),r=e-1,n=this.entries[r];this.entries[r]=t,this.entries[e]=n},t.prototype.down=function(t){var e=this.entries.indexOf(t),r=e+1,n=this.entries[r];this.entries[r]=t,this.entries[e]=n}}();!function(){function t(){var t=this;this.selectedTags={},this.tags.forEach((function(e){return t.selectedTags[e]=!0}))}t.prototype.onChange=function(){this.tags=l.a.keys(l.a.pickBy(this.selectedTags))},t.prototype.addCustom=function(t){l.a.isEmpty(t)||(this.selectedTags[t]=!0),this.inputVisible=!this.inputVisible}}();!function(){function t(){this.inputVisible=!1,this.allowedUnitValues=m(n),this.entries=this.entries||[]}t.prototype.add=function(t){this.isValidEntry(t)&&this.entries.push(new h(t.interval,t.unit,t.count)),this.inputVisible=!this.inputVisible},t.prototype.remove=function(t){this.entries=l.a.without(this.entries,t)},t.prototype.isValidEntry=function(t){return!isNaN(t.interval)&&!isNaN(t.count)}}();!function(){function t(){}t.prototype.add=function(t){t&&l.a.isNumber(parseInt(t,10))&&this.entries.push(t),this.inputVisible=!this.inputVisible},t.prototype.remove=function(t){this.entries=l.a.without(this.entries,t)}}();!function(){function t(t,e,r){this.uiSegmentSrv=r,this.aliasInputVisible=!1,this.aliasAddedVisible=!1,this.$scope=t,this.$q=e,this.uiSegmentSrv=r,this.promiseUtils=new F(e),this.segment=this.value?r.newSegment(this.value):r.newSelectMetric(),this.aliasAddedVisible=!l.a.isNil(this.alias)}t.$inject=["$scope","$q","uiSegmentSrv"],t.prototype.onChange=function(t){this.value=this.$scope.getMetricInputValue()},t.prototype.suggestMetrics=function(){var t=this,e=this.$scope.getMetricInputValue();return this.promiseUtils.resolvedPromise(this.metricNames.filter((function(t){return l.a.includes(t,e)})).slice(0,20).map((function(e){return t.uiSegmentSrv.newSegment(e)})))},t.prototype.setAlias=function(t){l.a.isEmpty(t)||(this.alias=t,this.aliasAddedVisible=!0),this.aliasInputVisible=!1}}();!function(){function t(t){this.uiSegmentSrv=t,this.selectedValues=(this.selectedValues||[]).filter(ct),this.segments=this.selectedValues.map(t.newSegment),this.showPlusButtonIfNeeded()}t.$inject=["uiSegmentSrv"],t.prototype.onChange=function(){this.showPlusButtonIfNeeded(),this.updateSelectedValues()},t.prototype.remove=function(t){this.segments=l.a.without(this.segments,t),this.updateSelectedValues()},t.prototype.showPlusButtonIfNeeded=function(){var t=l.a.last(this.segments);this.isPlusButton(t)||this.segments.push(this.uiSegmentSrv.newPlusButton())},t.prototype.updateSelectedValues=function(){var t=this;this.selectedValues=this.segments.filter((function(e){return!t.isPlusButton(e)})).map((function(t){return t.value}))},t.prototype.isPlusButton=function(t){return ct(t)&&"plus-button"===t.type&&l.a.isNil(t.value)}}();function ct(t){return!l.a.isNil(t)}Object(st.loadPluginCss)({dark:"../css/plugin.css",light:"../css/plugin.css"});var lt=function(t){function e(e,r){var n=t.call(this,e,r)||this;return n.aggregators=P,n.tagsInitializationError=void 0,n.targetValidator=new rt(n.datasource.enforceScalarSetting),n.legacyTargetConverter=new z,n.datasource.initialize().then((function(){return e.$apply()})),e.$watch("ctrl.target.query",n.onTargetChange.bind(n),!0),e.$watch("ctrl.target.query.metricName",n.onMetricNameChanged.bind(n)),n.legacyTargetConverter.isApplicable(n.target)&&(n.target.query=n.legacyTargetConverter.convert(n.target)),!n.target.query||n.target.query instanceof G?n.target.query=n.target.query||new G(n.target.query.metricName):n.target.query=G.fromObject(n.target.query),n.initializeTags(n.target.query.metricName,n.target.query,e),n}return e.$inject=["$scope","$injector"],Object(p.__extends)(e,t),e.prototype.getCollapsedText=function(){return this.target.query.asString()},e.prototype.onTargetChange=function(t,e){this.isTargetChanged(t,e)&&this.targetValidator.isValidTarget(t)&&this.refresh()},e.prototype.onMetricNameChanged=function(t,e,r){if(t!==e){var n=this.buildNewTarget(t);this.initializeTags(t,n,r),this.target.query=n}},e.prototype.buildNewTarget=function(t){var e=this.target.query,r=new G(t);return e&&(r.aggregators=e.aggregators,r.alias=e.alias,r.tags=e.tags,r.groupBy=e.groupBy,r.timeRange=e.timeRange,r.overrideScalar=e.overrideScalar),r},e.prototype.initializeTags=function(t,e,r){var n=this;this.clear(),t&&(this.tags=new ot,this.datasource.getMetricTags(t).then((function(t){return r.$apply((function(){return n.tags.updateTags(t)}))}),(function(t){return n.tagsInitializationError=t.data.message})).then((function(){if(!n.tagsInitializationError){var t={};Object.keys(e.tags).filter((function(t){return n.tags.tags.hasOwnProperty(t)})).forEach((function(r){t[r]=e.tags[r].filter((function(t){return n.tags.tags[r].indexOf(t)>-1||"$"===t.charAt(0)||"["===t.charAt(0)&&"]"===t.charAt(t.length-1)}))})),Object.keys(n.tags.tags).filter((function(t){return!e.tags.hasOwnProperty(t)})).forEach((function(e){return t[e]=[]})),e.tags=t,e.groupBy.tags&&(e.groupBy.tags=e.groupBy.tags.filter((function(t){return n.tags.tags.hasOwnProperty(t)})))}})))},e.prototype.isTargetChanged=function(t,e){return JSON.stringify(t)!==JSON.stringify(e)},e.prototype.clear=function(){this.tagsInitializationError=void 0},e.templateUrl="partials/query.editor.html",e}(st.QueryCtrl);r.d(e,"QueryOptionsCtrl",(function(){return pt})),r.d(e,"Datasource",(function(){return ut})),r.d(e,"QueryCtrl",(function(){return lt})),r.d(e,"ConfigCtrl",(function(){return o}));var pt=function(){function t(){}return t.templateUrl="partials/query.options.html",t}()}])}));
//# sourceMappingURL=module.js.map